pipeline {
    agent {
        docker {
            image 'python:3.9'
            args '-v /var/run/docker.sock:/var/run/docker.sock -u root'
        }
    }
    
    environment {
        APP_NAME = 'my-python-app'
        DEPLOY_HOST = '192.168.64.4'
        DEPLOY_PORT = '5000'
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'ğŸ“¦ Checking out code...'
                git branch: 'main', url: 'https://github.com/elorm116/Jenkins-101'
                sh 'ls -la'
            }
        }
        
        stage('Install Dependencies') {
            steps {
                echo 'ğŸ“‹ Installing Python dependencies...'
                sh 'pip install --upgrade pip'
                sh 'pip install -r my-python-app/requirements.txt'
                sh 'pip install pytest'  // For testing
            }
        }
        
        stage('Run Tests') {
            steps {
                echo 'ğŸ§ª Running tests...'
                dir('my-python-app') {
            sh 'python -m pytest test_app.py -v'
        }
    }
}
        
        stage('Build') {
            steps {
                 echo 'ğŸ—ï¸ Building application...'
                 dir('my-python-app') {
            sh 'python -m py_compile app.py'
        }
    }
}
        
        stage('Package') {
            steps {
                echo 'ğŸ“¦ Packaging application...'
                sh '''
                    mkdir -p dist
                    cp my-python-app/app.py dist/
                    cp my-python-app/requirements.txt dist/
                    cp my-python-app/deploy.sh dist/
                    ls -la dist/
                '''
                archiveArtifacts artifacts: 'dist/**/*', fingerprint: true
            }
        }
        
        stage('Deploy to Localhost') {
            steps {
                echo 'ğŸš€ Deploying to localhost...'
                script {
                    try {
                        // Copy files to deployment directory
                        sh '''
                            # Create deployment directory
                            mkdir -p /tmp/python-app-deploy
                            cp -r dist/* /tmp/python-app-deploy/
                            cd /tmp/python-app-deploy
                            
                            # Install dependencies in deployment environment
                            pip install -r requirements.txt
                            
                            # Make deploy script executable
                            chmod +x deploy.sh
                            
                            # Deploy the application
                            ./deploy.sh
                        '''
                        
                        echo 'âœ… Deployment completed successfully!'
                        echo 'ğŸŒ Application is running at: http://192.168.64.4:5000'
                        
                    } catch (Exception e) {
                        echo "âŒ Deployment failed: ${e.getMessage()}"
                        currentBuild.result = 'FAILURE'
                    }
                }
            }
        }
        
        stage('Health Check') {
            steps {
                echo 'ğŸ¥ Performing health check...'
                script {
                    try {
                        sh '''
                            # Wait for app to be ready
                            sleep 10
                            
                            # Check if app is responding
                            curl -f http://192.168.64.4:5000/health
                            
                            # Check main page
                            curl -f http://192.168.64.4:5000/
                        '''
                        echo 'âœ… Health check passed!'
                    } catch (Exception e) {
                        echo "âŒ Health check failed: ${e.getMessage()}"
                        currentBuild.result = 'FAILURE'
                    }
                }
            }
        }
    }
    
    post {
        always {
            echo 'ğŸ§¹ Cleaning up...'
            sh 'ls -la'
        }
        success {
            echo '''
            ğŸ‰ Pipeline completed successfully!
            
            ğŸ“‹ Summary:
            âœ… Code checked out
            âœ… Dependencies installed
            âœ… Tests passed
            âœ… Application built
            âœ… Deployment successful
            âœ… Health check passed
            
            ğŸŒ Your app is running at: http://192.168.64.4:5000
            ğŸ“Š Check the application logs at: /tmp/python-app-deploy/app.log
            '''
        }
        failure {
            echo '''
            âŒ Pipeline failed!
            
            ğŸ” Check the console output for errors.
            ğŸ“‹ Common issues:
            - Git repository URL incorrect
            - Dependencies not found
            - Tests failing
            - Port 5000 already in use
            '''
        }
    }
}